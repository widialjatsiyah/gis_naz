<?php
defined('BASEPATH') OR exit('No direct script access allowed');
class Geojson extends CI_Controller {
    public function __construct(){ parent::__construct(); $this->load->helper(['url','auth']); $this->load->library('session'); require_login(); if(!is_admin()) show_error('Forbidden',403); }
    public function import(){ if($this->input->method(TRUE)==='POST' && isset($_FILES['geojson'])){ $json=file_get_contents($_FILES['geojson']['tmp_name']); $data=json_decode($json,true); if(!$data) show_error('File GeoJSON tidak valid',422); if(!isset($data['type'])||$data['type']!=='FeatureCollection'){ if(isset($data['type'])&&$data['type']==='Feature'){ $data=['type'=>'FeatureCollection','features'=>[$data]]; } else { $data=['type'=>'FeatureCollection','features'=>[['type'=>'Feature','geometry'=>$data,'properties'=>new stdClass()]]]; } } $count=0; foreach($data['features'] as $ft){ $props = isset($ft['properties'])?$ft['properties']:new stdClass(); $geom = isset($ft['geometry'])?$ft['geometry']:null; if(!$geom) continue; $kel = $props['kelurahan'] ?? ($props['NAMOBJ'] ?? ($props['name'] ?? null)); $kat = $props['kategori'] ?? ($props['KATEGORI'] ?? null); $row=['kelurahan'=>$kel,'kategori'=>$kat,'name'=> $props['name'] ?? ($kel ?: null),'color'=>'#3388ff','geometry'=> json_encode($geom, JSON_UNESCAPED_UNICODE),'properties'=> json_encode($props, JSON_UNESCAPED_UNICODE)]; $this->db->insert('geojson_data',$row); $count++; } $this->session->set_flashdata('msg','Import selesai: '.$count); redirect('data'); } $this->load->view('layouts/header',['user'=>current_user()]); $this->load->view('geojson_import_form'); $this->load->view('layouts/footer'); } }
